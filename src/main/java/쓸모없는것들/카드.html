<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta
      name="viewport"
      content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0"
  />
  <meta http-equiv="X-UA-Compatible" content="ie=edge" />
  <title>Document</title>
  <style>
    img {
      width: 88px;
      margin: 10px;
      cursor: grab;
    }
    .on {
      border: chartreuse solid;
    }
    .header {
      display: flex;
      justify-content: space-between;
    }
  </style>
</head>
<body>
<div class="header">
  <div id="buttons">
    <button onclick="showAll()">show all</button>
    <button onclick="hideAll()">hide all</button>
    <button onclick="shuffleCards()">shuffle</button>
    <button onclick="start()">start</button>
  </div>
  <div id="timer"></div>
  <div id="score"></div>
</div>
<div id="card-board"></div>
</body>
<script>
  const PATH = 'images/';
  const EXT = '.png';
  const board = document.getElementById('card-board');
  const score = document.getElementById('score');
  const timer = document.getElementById('timer');
  let isShowAll;
  let prevCard;
  let time;
  let hasStarted;

  window.onload = () => {
    init();
    shuffleCards();
    hideAll();
  };

  const init = () => {
    prevCard = null;
    board.innerHTML = null;
    isShowAll = true;
    hasStarted = false;
    for (let i = 0; i < 52; i++) {
      board.innerHTML += `<img id=${i} src='${PATH + i + EXT}'/>`;
    }
    board.childNodes.forEach((card) =>
        card.addEventListener('click', clickCard)
    );
    score.innerHTML = '000';
    timer.innerHTML = '5m0s';
    time = 300;
  };

  const start = () => {
    if (hasStarted) {
      return;
    }
    let x = setInterval(() => {
      const min = parseInt(time / 60);
      const sec = time % 60;
      timer.innerHTML = min + 'm' + sec + 's';
      time--;
      if (time < 0) {
        clearInterval(x);
        timer.innerHTML = 'time over';
      }
    }, 1000);
    hasStarted = true;
    hideAll();
  };

  const clickCard = (e) => {
    const curCard = e.target;
    if (!hasStarted || isShowAll || isMatchedCard(curCard)) {
      return;
    }

    flipCards(0, curCard);

    if (!prevCard) {
      prevCard = curCard;
      return;
    }

    if (compareCards(prevCard, curCard)) {
      setMatchedCards(prevCard, curCard);
      plusScore();
    } else {
      flipCards(500, prevCard, curCard);
    }

    prevCard = null;
  };

  const setMatchedCards = (...cards) =>
      cards.forEach((card) => card.setAttribute('class', 'on'));

  const isMatchedCard = (card) => card.getAttribute('class') === 'on';

  const compareCards = (card1, card2) => {
    const id1 = parseInt(card1.id) - 1;
    const id2 = parseInt(card2.id) - 1;
    return (
        id1 % 13 === id2 % 13 &&
        Math.floor(id1 / 13) + Math.floor(id2 / 13) === 3
    );
  };

  const flipCards = (time, ...cards) => {
    setTimeout(() => {
      cards.forEach(
          (card) =>
              (card.src = card.getAttribute('src').endsWith('reverse.png')
                  ? getImagePath(card.id)
                  : getImagePath('reverse'))
      );
    }, time);
  };

  const shuffleCards = () => {
    if (hasStarted) {
      return;
    }
    for (let i = board.children.length - 1; i >= 0; i--) {
      board.appendChild(
          board.removeChild(board.children[(Math.random() * i) | 0])
      );
    }
  };

  const showAll = () => {
    isShowAll = true;
    board.childNodes.forEach((card) => (card.src = getImagePath(card.id)));
  };

  const hideAll = () =>
      board.childNodes.forEach((card) => {
        isShowAll = false;
        if (!isMatchedCard(card)) {
          card.src = getImagePath('reverse');
        }
      });

  const getImagePath = (filename) => PATH + filename + EXT;

  const plusScore = () => {
    score.innerHTML = String(Number(score.innerHTML) + 10).padStart(3, '0');
  };
</script>
</html>